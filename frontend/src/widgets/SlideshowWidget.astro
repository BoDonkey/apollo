---
const { widget } = Astro.props;
const placeholder = widget?.aposPlaceholder ? 'true' : '';
const url = widget?.video?.url;
---
<style>
  video-widget {
    width: 100%;
  }
</style>
<video-widget
  url={placeholder ? 'https://youtu.be/Q5UX9yexEyM' : url }
>
</video-widget>
<script>
  class VideoWidget extends HTMLElement {
    result: {
      width: number,
      height: number,
      html: string
    };
    canvasEl: HTMLElement;
    
    constructor() {
      super();
    }

    async init() {
      const videoUrl = this.getAttribute('url');

      if (!videoUrl) {
        return;
      }

      try {
        this.result = await this.oembed(videoUrl);
        this.renderVideo();
      } catch (error) {
        console.error('Error initializing video widget:', error);
      }
    }

    async oembed(url) {
      const response = await fetch('/api/v1/@apostrophecms/oembed/query?' + new URLSearchParams({
        url
      }));
      if (response.status >= 400) {
        throw new Error(`oembed error code: ${response.status}`);
      }
      return response.json();
    }

    renderVideo() {
      const shaker = document.createElement('div');
      shaker.innerHTML = this.result.html;
      const inner = shaker.firstChild;
      if (!(inner && (inner instanceof HTMLElement))) {
        throw new Error('First child must be an HTML element');
      }
      this.canvasEl = inner;
      this.innerHTML = '';
      if (!inner) {
        return;
      }
      inner.removeAttribute('width');
      inner.removeAttribute('height');
      this.append(inner);
      
      // wait for CSS width to be known
      setTimeout(() => {
        if (this.result.width && this.result.height) {
          inner.style.width = '100%';
          this.resizeVideo();
          window.addEventListener('resize', this.resizeHandler.bind(this));
        }
      }, 0);
    }

    resizeVideo() {
      this.canvasEl.style.height = ((this.result.height / this.result.width) * this.canvasEl.offsetWidth) + 'px';
    }

    resizeHandler() {
      if (document.contains(this)) {
        this.resizeVideo();
      } else {
        window.removeEventListener('resize', this.resizeHandler);
      }
    }
  }

  // Store video widget instances in a Map
  const videoWidgets = new Map();

  function initVideoWidgets() {
    // Clean up existing instances
    videoWidgets.clear();

    // Initialize new instances with a delay for ApostropheCMS wrapper setup
    setTimeout(() => {
      document.querySelectorAll('video-widget').forEach((widget, index) => {
        const instance = widget as VideoWidget;
        instance.init();
        videoWidgets.set(`video-${index}`, instance);
      });
    }, 500);
  }

  // Define the custom element
  customElements.define('video-widget', VideoWidget);

  // Initialize video widgets when the DOM is ready
  document.addEventListener('DOMContentLoaded', initVideoWidgets);

  // Handle ApostropheCMS refreshes and modal updates
  if (window.apos) {
    // Reinitialize on general content refresh
    apos.bus.$on('refreshed', initVideoWidgets);

    // Reinitialize when modal editing is complete
    apos.bus.$on('modal-resolved', initVideoWidgets);
  }
</script>